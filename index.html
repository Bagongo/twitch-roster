<!DOCTYPE hmtl>
<html>
<head>
<title>Twitch-Live-Streamers</title>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    
    <script src="https://use.fontawesome.com/c4baa82464.js"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
    
    
<style>
    
    body, html{
        width: 100%;
        margin: 0;
        padding: 0;
    }
    
    a{
        color: black;
        text-decoration: none;
    }
            
    .small-margin{
        margin: 10px;
    }
    
    #flex-container{
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #ext-frame{
        width: 750px;
        height: 80%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: antiquewhite;
    }
    
    #top-section{
        width: 100%;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        background-color: aqua;
    }
    
    #top-section *{
        margin: 5%;
    }
    
    #top-section img{
        width: 200px;
        height: auto;
    }
    
    #top-section input{
        height: 40px;
        align-self: center;
    }
    
    #clone-01{
        display: none;
    }
    
    #results-cont{
        width: 300px;
        height: 80%;
        max-height: 80%;
        overflow: scroll;
        background-color: black;
    }
    
    .result{
        width: 100%;
        height: auto;
        min-height: 75px;
        display: flex;
        flex-direction: column;
        background-color: wheat;
    }
    
    .info-head{
        height: 50%;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
        background-color: skyblue;
    }
    
    .online-symbol{
        width: 10px;
        height: 10px;
        float: right;
        border-radius: 5px;
        background-color: red;
    }
    
</style>    

<body>
       
    <div id="flex-container">
    
        <div id="ext-frame">
            
            <div id="top-section">
                <img src="http://blog.maniaplanet.com/wp-content/uploads/2013/03/new-twitchtv-logo.png" />
                <input type="text" />
            </div>
            
            <br />
            
            <div id="button-box">
                <button id="all">All</button>
                <button id="online">Online</button>
                <button id="offline">Offline</button>
            </div>
            
            <div id="clone-01" class="result">
                <a href="" target="_blank">
                    <div class="info-head">
                        <h4 class="small-margin"></h4>
                        <div class="online-symbol small-margin"></div>
                    </div>
                    <p class="small-margin"></p>
                </a>
            </div>   
            
            <div id="results-cont"></div>
        
        </div>
       
    </div>
        
           
    <script>
    
        window.onload = function(){
            
            var favorites = ["ESL_SC2", "OgamingSC2", "cretetion", "freecodecamp", "storbeck", "habathcx", "RobotCaleb", "noobs2ninjas", "brunofin", "comster404"];                    
            var currentState = "all";
            var buttonsLocked = false;
            var users = [];
            
            var buttons = document.getElementById("button-box").children;            
            for(var i=0; i < buttons.length; i++)
            {
                buttons[i].addEventListener("click", function(){                
                    if(!buttonsLocked)
                    {
                        buttonsLocked = true;
                        currentState = this.id;                        
                        var resultsBox = document.getElementById("results-cont");
                        while(resultsBox.firstChild)
                            resultsBox.removeChild(resultsBox.firstChild);
                        
                        users = [];                        
                        sendRequest(favorites, getStreams);
                    }
                });
            }
            
            function sendRequest(arr, foo)
            {
                for(var i=0; i < arr.length; i++)
                {
                    var lastCall = i >= arr.length - 1 ? true : false;
                    foo.call(foo, arr[i], lastCall);
                }
            }
                             
            function getStreams(name, isLastCall)
            {
                var xhttp = new XMLHttpRequest();
                                
                xhttp.onreadystatechange = function(){
                    if (xhttp.readyState == 4) 
                    {
                        if(xhttp.status == 200)
                        {                                                  
                            var result = JSON.parse(xhttp.responseText);
                            result.userName = name;
                            result.isOnline = result.stream != null;
                            users.push(result);
                        
                            if(isLastCall)
                                lastCallHandler(false);
                        }
                        else
                        {
                            console.log("Error", xhttp.statusText);
                            
                            if(isLastCall)
                                lastCallHandler(false);                        
                        }
                    }
                };
                
                xhttp.open("GET", "https://api.twitch.tv/kraken/streams/" + name, true);
                xhttp.setRequestHeader("Client-ID", "qommjzx8gzcyskocbzmig7rh1zi2i3");
                xhttp.send();   
            }
            
            function getChannels(name, isLastCall)
            {
                var xhttp = new XMLHttpRequest();
                
                xhttp.onreadystatechange = function(){
                    if (xhttp.readyState == 4) 
                    {
                        if(xhttp.status == 200)
                        {                      
                            if(isLastCall)
                                lastCallHandler(true);
                        }
                        else
                        {
                            console.log("Error", xhttp.statusText);
                            
                            for(var i=0; i < users.length; i++)
                            {
                                if(users[i].userName === name)
                                    users[i].closedChannel = true; 
                            }
                            
                            if(isLastCall)
                                lastCallHandler(true);
                        }
                    }
                };
                
                xhttp.open("GET", "https://api.twitch.tv/kraken/channels/" + name, true);
                xhttp.setRequestHeader("Client-ID", "qommjzx8gzcyskocbzmig7rh1zi2i3");
                xhttp.send();   
            }
            
            function lastCallHandler(serverCallsDone)
            {
                if(serverCallsDone)
                {
                    filterUsersArray();
                    buttonsLocked = false;
                }
                else
                    sendRequest(favorites, getChannels)
            }
            
            function filterUsersArray()
            {
                console.log(users);
                
                if(currentState !== "all")
                {
                    var mustBeOnline = currentState === "online" ? true : false;
                    
                    users = users.filter(function(currUser){
                        return currUser.isOnline === mustBeOnline;
                    });
                }
                
                setTimeout(fillResultsField, 100);
            }
            
            function fillResultsField()
            {                 
                for(var i=0; i < users.length; i++)
                { 
                    var resultClone = document.getElementById("clone-01").cloneNode(true);
                    var link = resultClone.firstElementChild;
                    var header = resultClone.firstElementChild.firstElementChild;
                    resultClone.removeAttribute("id");
                    header.getElementsByTagName('h4')[0].innerHTML = users[i].userName;
                    link.href = "https://www.twitch.tv/" + users[i].userName;
                
                    if(users[i].isOnline)
                    {
                        resultClone.getElementsByTagName('p')[0].innerHTML = users[i].stream.channel.status;
                        header.getElementsByTagName('div')[0].style.backgroundColor = "green";
                    }

                    if(users[i].closedChannel)
                        header.getElementsByTagName('div')[0].style.backgroundColor = "grey";
                    
                    document.getElementById("results-cont").appendChild(resultClone);
                }
            }
            
        };
        
    </script>
    
</body>
    
</html>

