<!DOCTYPE hmtl>
<html>
<head>
<title>Twitch-Live-Streamers</title>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    
    <script src="https://use.fontawesome.com/c4baa82464.js"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
    
    
<style>
    
    body, html{
        width: 100%;
        margin: 0;
        padding: 0;
    }
    
    a{
        color: black;
        text-decoration: none;
    }
            
    .small-margin{
        margin: 10px;
    }
    
    #flex-container{
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #ext-frame{
        width: 750px;
        height: 80%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: antiquewhite;
    }
    
    #top-section{
        width: 100%;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        background-color: aqua;
    }
    
    #top-section > *{
        margin: 5%;
    }
    
    #top-section img{
        width: 200px;
        height: auto;
    }
    
    form{
        display: flex;
        flex-flow: row;
        flex-wrap: nowrap;       
    }
    
    form input{
        height: 40px;
        align-self: center;
    }
    
    form button{
        height: 40px;
        margin: 0 0 0 5px;
        align-self: center;
    }
    
    #clone-01{
        display: none;
    }
    
    #results-cont{
        width: 300px;
        height: 80%;
        max-height: 80%;
        overflow: scroll;
        background-color: black;
    }
    
    .result{
        width: 100%;
        height: 100px;
        display: flex;
        flex-direction: column;
        background-color: wheat;
    }
    
    .info-head{
        height: 35px;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
        background-color: skyblue;
    }
    
    .online-symbol{
        width: 10px;
        height: 10px;
        float: right;
        border-radius: 5px;
        background-color: red;
    }
    
     #server-search{
        display: none;
        width: 300px;
        height: 100px;
    }
    
    #server-search > div > *{
        display: inline-block;       
    }
    
    #server-search .online-symbol{
        background-color: grey;
    }
    
    #server-search button{
        display: none;
    }
    
</style>    

<body>
       
    <div id="flex-container">
    
        <div id="ext-frame">
            
            <div id="top-section">
                <img src="http://blog.maniaplanet.com/wp-content/uploads/2013/03/new-twitchtv-logo.png" />
                <form>
                    <input id="search-bar" type="text"/>
                    <button id="search-btn">search on servers</button>
                </form>
                <div id="search-result"></div>
            </div>
            
            <br />
            
            <div id="server-search" class="result">
                <a href="" target="_blank">
                    <div class="info-head">
                        <h4 class="small-margin"></h4>
                        <div class="online-symbol small-margin"></div>
                    </div>
                </a>
                <div>
                    <p class="small-margin">User not found</p>
                    <button id="add">add</button>
                    <button id="close">close</button>
                </div>
            </div>
            
            <div id="your-favs">
                <h3>Your Favorites</h3>
            </div>
            
            <div id="button-box">
                <button id="all">All</button>
                <button id="online">Online</button>
                <button id="offline">Offline</button>
            </div>
            
            <div id="clone-01" class="result">
                <a href="" target="_blank">
                    <div class="info-head">
                        <h4 class="small-margin"></h4>
                        <div class="online-symbol small-margin"></div>
                    </div>
                    <p class="small-margin"></p>
                </a>
            </div>   
            
            <div id="results-cont"></div>
        
        </div>
       
    </div>
        
           
    <script>
    
        window.onload = function(){
            
            var favorites = ["ESL_SC2", "OgamingSC2", "cretetion", "freecodecamp", "storbeck", "habathcx", "RobotCaleb", "noobs2ninjas", "brunofin", "comster404"];                    
            var currentState = "all";
            var buttonsLocked = false;
            var users = [];
            var newUser = "";
            document.getElementById("search-bar").addEventListener("keyup", searchUserLocal);
            document.getElementById("search-btn").addEventListener("click", searchUserOnServer);
            var serverSearch = document.getElementById("server-search");
            serverSearch.getElementsByTagName("button")[0].addEventListener("click", addToFavs);
            serverSearch.getElementsByTagName("button")[1].addEventListener("click", dismissResult);
            var yourFavs = document.getElementsByTagName("h3")[0];
            var buttons = document.getElementById("button-box").children;            
            for(var i=0; i < buttons.length; i++)
            {
                buttons[i].addEventListener("click", function(){                
                    if(!buttonsLocked)
                    {
                        buttonsLocked = true;
                        currentState = this.id;                        
                        var resultsBox = document.getElementById("results-cont");
                        
                        while(resultsBox.firstChild)
                            resultsBox.removeChild(resultsBox.firstChild);
                        
                        users = [];                        
                        makeRequests("streams");
                    }
                });
            }
            
            function makeRequests(type)
            {
                for(var i=0; i < favorites.length; i++)
                {
                    var lastCall = i >= favorites.length - 1 ? true : false;
                    var callback = type === "streams" ? updateStreamInfo : updateChannelInfo;
                    sendRequest(favorites[i], type, callback, lastCall);
                }
            }
                             
            function sendRequest(name, type, callback, isLastCall)
            {
                var xhttp = new XMLHttpRequest();
                                
                xhttp.onreadystatechange = function(){
                    if (xhttp.readyState == 4) 
                    {
                        if(xhttp.status == 200)
                        {                                                  
                            var result = JSON.parse(xhttp.responseText);
                            callback.call(callback, name, result);
                        
                            if(isLastCall)
                                lastCallHandler(type);
                        }
                        else
                        {
                            alert("Error", xhttp.statusText);
                            
                            if(isLastCall)
                                lastCallHandler(type);                        
                        }
                    }
                };
                
                xhttp.open("GET", "https://wind-bow.gomix.me/twitch-api/" + type + "/" + name, true);
                xhttp.send();   
            }
            
            function updateStreamInfo(name, data)
            {
                data.userName = name;
                data.isOnline = data.stream != null;
                users.push(data);                
            }
            
            function updateChannelInfo(name, data)
            {                
                if(data.error == "Not Found")
                {
                    for(var i=0; i < users.length; i++)
                    {
                        if(users[i].userName === name)
                        users[i].closedChannel = true; 
                    }
                }                
            }
            
            function lastCallHandler(type)
            {
                if(type === "channels")
                {
                    filterUsersArray();
                    buttonsLocked = false;
                }
                else
                    makeRequests("channels");
            }
            
            function filterUsersArray()
            {                
                if(currentState !== "all")
                {
                    var mustBeOnline = currentState === "online" ? true : false;
                    
                    users = users.filter(function(currUser){
                        return currUser.isOnline === mustBeOnline;
                    });
                }
                
                fillResultsField();
            }
            
            function fillResultsField()
            {                 
                for(var i=0; i < users.length; i++)
                { 
                    var resultClone = document.getElementById("clone-01").cloneNode(true);
                    var link = resultClone.firstElementChild;
                    var header = resultClone.firstElementChild.firstElementChild;
                    resultClone.id = users[i].userName;
                    var status = "offline";
                    var color = "red";
                    
                    if(users[i].isOnline)
                    {
                        status = users[i].stream.channel.status;
                        color = "green";
                    }

                    if(users[i].closedChannel)
                    {      
                        status = "channel closed";
                        color = "grey";
                    }
                    
                    header.getElementsByTagName('h4')[0].innerHTML = users[i].userName;
                    link.href = "https://www.twitch.tv/" + users[i].userName;
                    resultClone.getElementsByTagName('p')[0].innerHTML = status;
                    header.getElementsByTagName('div')[0].style.backgroundColor = color;
                    document.getElementById("results-cont").appendChild(resultClone);
                }
            }
            
            function searchUserLocal()
            {
                var typed = this.value.toString().toLowerCase(); 
                var results = document.getElementById("results-cont").children;

                if(typed.length >= 2)
                {                      
                    for(var j=0; j < results.length; j++)
                    {
                        if(results[j].id.substr(0, typed.length).toLocaleLowerCase() !== typed)
                            results[j].style.display = "none";
                        else
                            results[j].style.display = "flex";
                    }
                } 
                else
                {
                   for(var i=0; i < results.length; i++)
                        results[i].style.display = "flex";
                }                
            }
            
            function searchUserOnServer(e)
            {
                e.preventDefault();
                var toSearch = document.getElementById("search-bar").value;
                
                if(favorites.indexOf(toSearch) < 0)
                {
                    sendRequest(toSearch, "channels", serverSearchResult, false);                    
                }
            }
            
            function serverSearchResult(name, result)
            {
                yourFavs.style.display = "none";
                serverSearch.style.display = "inline-block";
                serverSearch.getElementsByTagName("h4")[0].innerHTML = name;
                serverSearch.getElementsByTagName("div")[0].getElementsByTagName("div")[0].style.backgroundColor = "grey";
                var status = serverSearch.getElementsByTagName("p")[0];
                var buttons = serverSearch.getElementsByTagName("button");
                buttons[0].style.display = buttons[1].style.display = "none";
                
                if(result.hasOwnProperty("error"))
                {
                    status.innerHTML = "User not found!";
                    buttons[1].style.display = "inline-block";
                }
                else
                {
                    newUser = name;
                    status.innerHTML = "User found!";
                    buttons[0].style.display = buttons[1].style.display = "inline-block";
                    sendRequest(name, "streams", updateColor, false);
                }                
            }
            
            function updateColor(name, result)
            {
                console.log(result);
                serverSearch.getElementsByTagName("div")[0].getElementsByTagName("div")[0].style.backgroundColor = result.stream ==! null ? "green" : "red"; 
            }
                        
            function addToFavs()
            {
                favorites.push(newUser);
                dismissResult();
            }
            
            function dismissResult()
            {
                yourFavs.style.display = "inline-block";
                serverSearch.style.display = "none";                
            }
            
        };
        
    </script>
    
</body>
    
</html>

